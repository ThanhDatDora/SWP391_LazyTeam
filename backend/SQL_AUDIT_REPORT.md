# SQL Usage Audit — backend

Date: 2025-11-08
Scope: searched for occurrences of the pattern `sql.query` under `backend/**`

Summary
- Total matches found (grep): 100+ (many are maintenance/backup scripts). The search returned many utility and maintenance scripts that use the global `sql` helper directly.
- Runtime code (controllers/routes/middleware/integration) appears to be using the pooled pattern (`getPool()` + `pool.request()`) except for a few earlier spots that were converted during this session.

Classification (representative files)

Runtime / production code (checked & OK)
- backend/controllers/exam-controller.js — converted to use pooled requests (`getPool()` and `pool.request()`), no remaining `sql.query` in runtime controllers.
- backend/routes/* — most routes use `getPool()` (grepped). No `sql.query` occurrences found in `backend/routes`.
- backend/integration/* — integration helpers use `getPool()` (they are test helpers, left as pooled usage).

Maintenance / ad-hoc scripts (use global `sql.query`)
These are scripts intended for one-off checks / migrations / fixes. They use `sql.query` or template tag forms and are fine to keep as standalone scripts, but can be migrated if you'd like consistency.
- backend/check-all-exam-data.cjs
- backend/check-table-structure.cjs
- backend/check-course9-moocs.cjs
- backend/create-missing-exams.cjs
- backend/check-complete-database.cjs
- backend/create-testuser.cjs
- backend/check-question.cjs
- backend/find-option-tables.cjs
- backend/check-question-options.cjs
- backend/mark-lessons-completed.cjs
- backend/check-progress-table.cjs
- backend/check-exam-submission-status.cjs
- backend/clear-exam-cooldown-user5.cjs
- backend/fix-user5-password.cjs
- backend/fix-all-exam-issues.cjs
- backend/quick-final-test.cjs
- backend/check-questions-detailed.cjs
- backend/check-options-table.cjs
- backend/test-complete-exam-flow.cjs
- backend/check-current-state.cjs
- backend/check-user-lessons.cjs
- backend/debug-submit-direct.cjs (converted during this session to use pooled requests)

Backups and archived scripts (under backup_20251106_200503/)
- backup_20251106_200503/backend/* — many scripts here use `sql.query`. These are archival and can be ignored for runtime audit.

Notes & Recommendations
1. Runtime safety
   - The runtime code paths (controllers/routes/middleware) should use a shared ConnectionPool and create transactions bound to that pool: `const pool = await getPool(); const transaction = new sql.Transaction(pool);`.
   - We've converted the main `exam-controller` occurrences and the debug submit script to follow this pattern.

2. Maintenance scripts
   - Maintenance scripts (the `*.cjs` scripts and `backup_*/` scripts) are typically executed standalone using `node script.cjs`. They often use `sql.query` or `sql.connect()` directly — that's acceptable for one-off tools.
   - If you want consistent patterns across the repo, we can convert maintenance scripts to use `getPool()` or to require a small `db` helper that returns a pool. This is low priority unless you plan to run them programmatically or in CI.

3. Recommended next actions (pick from these)
   - Option A (conservative): Keep maintenance scripts as-is. Mark runtime audit complete.
   - Option B (standardize): Convert a small subset of maintenance scripts you run frequently to use `getPool()` and pooled requests.
   - Option C (CI-friendly): Add a lint rule or codemod (grep + automated patch) to flag uses of global `sql.query` in non-script files and optionally replace with `pool.request()` where safe.

4. Follow-ups I can do now
   - Produce a prioritized list of maintenance scripts to convert (based on frequency or importance).
   - Convert a selected script or two to use pooled requests and transactions.
   - Add a short README section documenting the recommended DB pattern.

If you'd like, I can now:
- Convert additional maintenance scripts to the pooled pattern (pick N files), or
- Create a short `backend/DB_USAGE_GUIDELINES.md` documenting the pattern and example code, or
- Produce a CI-friendly codemod/PR that finds and replaces `sql.query` in runtime files (not recommended for backups without review).

---
Generated by automated audit on the workspace.
